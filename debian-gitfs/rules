#!/usr/bin/make -f
# -*- makefile -*-
# Sample debian/rules that uses debhelper.
# This file was originally written by Joey Hess and Craig Small.
# As a special exception, when this file is copied by dh-make into a
# dh-make output file, you may use that output file without restriction.
# This special exception was added by Craig Small in version 0.37 of dh-make.

# Uncomment this to turn on verbose mode.
export LANGUAGE=en_US.UTF-8
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

%:
	dh $@

override_dh_auto_configure:
	@echo "[easy_install]" >> $(shell pwd)/.pydistutils.cfg
	@echo "allow_hosts = ''" >> $(shell pwd)/.pydistutils.cfg
	@echo "find_links = file://$(shell pwd)/debian/packages/" >> $(shell pwd)/.pydistutils.cfg

override_dh_auto_build:
	# Build a self-contained pex without invoking upstream Makefile (no uv in chroot)
	mkdir -p build/src
	# Create a clean copy of the source, excluding venvs and build artifacts that break pex hashing
	tar -C $(CURDIR) \
		--exclude=./debian \
		--exclude=./build \
		--exclude=./.git \
		--exclude=./.venv \
		--exclude=./test_venv \
		-cf - . | tar -C build/src -xf -
	export HOME=$(CURDIR) PIP_NO_INDEX=1 PIP_FIND_LINKS=$(CURDIR)/debian/packages && \
		/usr/bin/pex -v --disable-cache --no-pypi \
		--pex-root=$(CURDIR)/debian/packages \
		--repo=$(CURDIR)/debian/packages \
		--find-links=$(CURDIR)/debian/packages \
		build/src -m gitfs:mount -o build/gitfs

override_dh_auto_install:
	mkdir -p debian/gitfs/usr/bin
	install -m 0755 build/gitfs debian/gitfs/usr/bin/gitfs

override_dh_auto_test:
