#!/usr/bin/make -f
# -*- makefile -*-
# Sample debian/rules that uses debhelper.
# This file was originally written by Joey Hess and Craig Small.
# As a special exception, when this file is copied by dh-make into a
# dh-make output file, you may use that output file without restriction.
# This special exception was added by Craig Small in version 0.37 of dh-make.

# Uncomment this to turn on verbose mode.
export LANGUAGE=en_US.UTF-8
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

%:
	dh $@

override_dh_auto_configure:
	# Skip pydistutils.cfg creation to avoid conflicts with pip

override_dh_auto_build:
	# Build a self-contained pex without invoking upstream Makefile (no uv in chroot)
	mkdir -p build/src build/wheels
	# Create a clean copy of the source, excluding venvs and build artifacts that break pex hashing
	tar -C $(CURDIR) \
		--exclude=./debian \
		--exclude=./build \
		--exclude=./.git \
		--exclude=./.venv \
		--exclude=./test_venv \
		-cf - . | tar -C build/src -xf -
	# Create a virtual environment for build dependencies
	python3 -m venv $(CURDIR)/build/venv
	# Upgrade pip to ensure wheel support
	$(CURDIR)/build/venv/bin/pip install --upgrade --no-index --find-links=$(CURDIR)/debian/packages pip setuptools wheel
	# Ensure build-time deps needed by pygit2 are available in the env
	# pycparser is required to build cffi; cffi is required to build pygit2's _libgit2 module
	$(CURDIR)/build/venv/bin/pip install --no-index --find-links=$(CURDIR)/debian/packages pycparser cffi || true
	# Manually unpack and install wheel files into the venv using Python's zipfile
	$(CURDIR)/build/venv/bin/python3 -c "import os; import zipfile; import shutil; from pathlib import Path; packages_dir = Path('$(CURDIR)/debian/packages'); site_packages = Path('$(CURDIR)/build/venv/lib/python3.12/site-packages'); [print(f'Unpacking {wheel_path.name}') or zipfile.ZipFile(wheel_path, 'r').extractall(site_packages) or print(f'Installed {wheel_path.name}') for wheel_path in packages_dir.glob('*.whl')]"
	# Also ensure flit-core is available for building
	$(CURDIR)/build/venv/bin/pip install --no-index --find-links=$(CURDIR)/debian/packages flit-core || true
	# Copy existing wheels to build/wheels
	cp $(CURDIR)/debian/packages/*.whl $(CURDIR)/build/wheels/ || true
	# Build pip, setuptools, and wheel first as wheels (for pex bootstrapping)
	for pkg in $(CURDIR)/debian/packages/pip-*.tar.gz $(CURDIR)/debian/packages/setuptools-*.tar.gz $(CURDIR)/debian/packages/wheel-*.tar.gz; do \
		if [ -f "$$pkg" ]; then \
			echo "Building wheel for $$pkg"; \
			$(CURDIR)/build/venv/bin/pip wheel --no-deps --no-index --no-build-isolation \
				--wheel-dir=$(CURDIR)/build/wheels "$$pkg" || true; \
		fi; \
	done
	# Build other source packages to wheels (skip atomiclong, mfusepy, and build backends handled separately)
	for pkg in $(CURDIR)/debian/packages/*.tar.gz; do \
		case "$$pkg" in \
			*atomiclong*|*mfusepy*|*pip-*|*setuptools-*|*wheel-*) ;; \
			*) \
				if [ -f "$$pkg" ]; then \
					echo "Building wheel for $$pkg"; \
					$(CURDIR)/build/venv/bin/pip wheel --no-deps --no-index --no-build-isolation \
						--find-links=$(CURDIR)/debian/packages \
						--wheel-dir=$(CURDIR)/build/wheels "$$pkg" || true; \
				fi ;; \
		esac; \
	done
	# Pre-build the gitfs wheel using pip with build deps available
	export HOME=$(CURDIR) && \
		$(CURDIR)/build/venv/bin/pip wheel --no-deps --no-index --no-build-isolation \
		--find-links=$(CURDIR)/build/wheels \
		--wheel-dir=$(CURDIR)/build/wheels build/src
	# Install cffi wheel first so atomiclong can use it
	$(CURDIR)/build/venv/bin/pip install --no-index --find-links=$(CURDIR)/build/wheels cffi || true
	# Build atomiclong wheel (needs cffi available)
	cd $(CURDIR)/debian/packages && tar xzf atomiclong-0.1.1.tar.gz && \
		cd atomiclong-0.1.1 && \
		$(CURDIR)/build/venv/bin/python3 setup.py bdist_wheel --dist-dir=$(CURDIR)/build/wheels || true
	# Build mfusepy wheel (fix multiple pyproject.toml issues)
	cd $(CURDIR)/debian/packages && tar xzf mfusepy-3.0.0.tar.gz && \
		cd mfusepy-3.0.0 && \
		sed -i 's/license = "ISC"/license = {text = "ISC"}/' pyproject.toml && \
		sed -i '/license-files/d' pyproject.toml && \
		$(CURDIR)/build/venv/bin/pip wheel --no-deps --no-index --no-build-isolation --wheel-dir=$(CURDIR)/build/wheels . || \
		$(CURDIR)/build/venv/bin/python3 -c "from setuptools import setup; setup(name='mfusepy', version='1.1.0', py_modules=['mfusepy'])" bdist_wheel --dist-dir=$(CURDIR)/build/wheels || true
	# Use pex with all pre-built wheels (completely offline)
	( \
		export HOME=$(CURDIR); \
		export PEX_IGNORE_RCFILES=1; \
		export PEX_PYTHON=/usr/bin/python3; \
		export PIP_NO_INDEX=1; \
		export PIP_FIND_LINKS="$(CURDIR)/build/wheels $(CURDIR)/debian/packages"; \
		export PEX_RESOLVE_TAGS='cp312-cp312-linux_x86_64'; \
		/usr/bin/pex \
			--no-pypi \
			--find-links=$(CURDIR)/build/wheels \
			--no-build \
			--disable-cache \
			--pip-version 25.2 \
			--interpreter-constraint='>=3.12,<3.13' \
			atomiclong==0.1.1 \
			cffi==1.17.1 \
			mfusepy==3.0.0 \
			pycparser==2.22 \
			pygit2==1.18.0 \
			sentry-sdk==2.30.0 \
			gitfs==1.0.0 \
			-m gitfs:mount \
			-o build/gitfs \
	)

override_dh_auto_install:
	mkdir -p debian/gitfs/usr/bin
	install -m 0755 build/gitfs debian/gitfs/usr/bin/gitfs

override_dh_auto_test:
